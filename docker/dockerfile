# syntax=docker/dockerfile:1.4

# --- Stage 1: Isaac Sim Downloader ---
FROM alpine AS downloader
WORKDIR /isaac-sim
RUN apk add --no-cache wget unzip && \
    wget -c https://download.isaacsim.omniverse.nvidia.com/isaac-sim-standalone-5.0.0-linux-x86_64.zip -O isaac-sim.zip && \
    unzip isaac-sim.zip && \
    rm isaac-sim.zip

# --- Stage 2: Main image ---
FROM ros:jazzy-perception
ENV DEBIAN_FRONTEND=noninteractive
ENV DOCKER_USER_HOME=/root

# Python venv
RUN apt-get update && apt-get install -y python3-venv && \
    python3 -m venv /isaac && \
    echo "source /isaac/bin/activate" >> /root/.bashrc
ENV VIRTUAL_ENV=/isaac
ENV PATH="$VIRTUAL_ENV/bin:$PATH"
RUN pip install --upgrade pip

# Basic utilities
RUN apt-get update && apt-get install -y \
    git vim cmake build-essential unzip && \
    rm -rf /var/lib/apt/lists/*

# Copy Isaac Sim from downloader stage
COPY --from=downloader /isaac-sim /isaac-sim

# Environment variables
ENV ISAACSIM_PATH=/isaac-sim
ENV PYTHONPATH=${ISAACLAB_PATH}/source:${PYTHONPATH}

# Source ROS2 and Isaac paths
RUN echo "source /opt/ros/jazzy/setup.bash" >> /root/.bashrc && \
    echo "export ISAACSIM_PATH=${ISAACSIM_PATH}" >> /root/.bashrc && \
    echo "export PYTHONPATH=\${ISAACLAB_PATH}/source:\${PYTHONPATH}" >> /root/.bashrc

WORKDIR /IsaacPanda
